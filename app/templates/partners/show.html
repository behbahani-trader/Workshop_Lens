{% extends "base.html" %}

{% block title %}{{ partner.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{{ url_for('partners.index') }}" class="flex items-center gap-2">
        <span>ğŸ¤</span>
        <span>Ø´Ø±Ú©Ø§</span>
    </a>
</li>
<li class="breadcrumb-item">
    <span class="flex items-center gap-2 text-primary">
        <span>ğŸ‘¤</span>
        <span>{{ partner.name }}</span>
    </span>
</li>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-4xl font-bold mb-2">ğŸ‘¤ {{ partner.name }}</h1>
            <p class="text-base-content/70">Ø¬Ø²Ø¦ÛŒØ§Øª Ø´Ø±ÛŒÚ© Ùˆ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('partners.index') }}" class="btn btn-outline">
                <span class="ml-2">ğŸ”™</span>
                Ø¨Ø§Ø²Ú¯Ø´Øª
            </a>
            <a href="{{ url_for('partners.add_transaction', id=partner.id) }}" class="btn btn-success">
                <span class="ml-2">ğŸ’°</span>
                ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯
            </a>
            <a href="{{ url_for('partners.edit', id=partner.id) }}" class="btn btn-warning">
                <span class="ml-2">âœï¸</span>
                ÙˆÛŒØ±Ø§ÛŒØ´
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø±ÛŒÚ© -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Ú©Ø§Ø±Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
            <div class="card bg-gradient-to-br from-primary to-primary-focus text-primary-content shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø±ÛŒÚ©</h2>
                    <div class="space-y-3">
                        <div>
                            <div class="text-sm opacity-80">Ù†Ø§Ù…</div>
                            <div class="font-bold">{{ partner.name }}</div>
                        </div>
                        {% if partner.phone %}
                        <div>
                            <div class="text-sm opacity-80">ØªÙ„ÙÙ†</div>
                            <div class="font-bold">ğŸ“ {{ partner.phone }}</div>
                        </div>
                        {% endif %}
                        {% if partner.email %}
                        <div>
                            <div class="text-sm opacity-80">Ø§ÛŒÙ…ÛŒÙ„</div>
                            <div class="font-bold">ğŸ“§ {{ partner.email }}</div>
                        </div>
                        {% endif %}
                        <div>
                            <div class="text-sm opacity-80">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</div>
                            <div class="font-bold">{{ partner.created_at.strftime('%Y/%m/%d') }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø¢Ù…Ø§Ø± Ù…Ø§Ù„ÛŒ -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-header bg-secondary text-secondary-content p-4 rounded-t-2xl">
                    <h3 class="card-title">ğŸ“Š Ø¢Ù…Ø§Ø± Ù…Ø§Ù„ÛŒ</h3>
                </div>
                <div class="card-body">
                    <div class="space-y-4">
                        <div class="text-center p-4 bg-success text-success-content rounded-lg">
                            <div class="text-2xl font-bold">{{ "{:,}".format(total_deposits|int) }}</div>
                            <div class="text-sm opacity-80">Ú©Ù„ ÙˆØ§Ø±ÛŒØ²ÛŒ (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>
                        
                        <div class="text-center p-4 bg-error text-error-content rounded-lg">
                            <div class="text-2xl font-bold">{{ "{:,}".format(total_withdrawals|int) }}</div>
                            <div class="text-sm opacity-80">Ú©Ù„ Ø¨Ø±Ø¯Ø§Ø´ØªÛŒ (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>
                        
                        <div class="text-center p-4 bg-{% if balance >= 0 %}info{% else %}warning{% endif %} text-{% if balance >= 0 %}info{% else %}warning{% endif %}-content rounded-lg">
                            <div class="text-3xl font-bold">
                                {% if balance > 0 %}+{% endif %}{{ "{:,}".format(balance|int) }}
                            </div>
                            <div class="text-sm opacity-80">Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ (ØªÙˆÙ…Ø§Ù†)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ -->
            {% if partner.notes %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-header bg-info text-info-content p-4 rounded-t-2xl">
                    <h3 class="card-title">ğŸ“ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</h3>
                </div>
                <div class="card-body">
                    <p class="text-sm">{{ partner.notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-header bg-warning text-warning-content p-4 rounded-t-2xl">
                    <div class="flex justify-between items-center">
                        <h3 class="card-title">ğŸ’° ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
                        <a href="{{ url_for('partners.add_transaction', id=partner.id) }}" class="btn btn-sm btn-warning-content">
                            <span class="ml-1">â•</span>
                            ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if transactions %}
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>ØªØ§Ø±ÛŒØ®</th>
                                    <th>Ù†ÙˆØ¹</th>
                                    <th>Ù…Ø¨Ù„Øº</th>
                                    <th>Ø´Ø±Ø­</th>
                                    <th>Ù…Ø§Ù†Ø¯Ù‡</th>
                                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set running_balance = 0 %}
                                {% for transaction in transactions %}
                                    {% if transaction.transaction_type == 'deposit' %}
                                        {% set running_balance = running_balance + transaction.amount %}
                                    {% else %}
                                        {% set running_balance = running_balance - transaction.amount %}
                                    {% endif %}
                                <tr>
                                    <td class="text-sm">{{ transaction.transaction_date.strftime('%Y/%m/%d') }}</td>
                                    <td>
                                        {% if transaction.transaction_type == 'deposit' %}
                                            <span class="badge badge-success">ğŸ’µ ÙˆØ§Ø±ÛŒØ²</span>
                                        {% else %}
                                            <span class="badge badge-error">ğŸ’¸ Ø¨Ø±Ø¯Ø§Ø´Øª</span>
                                        {% endif %}
                                    </td>
                                    <td class="font-mono">
                                        {% if transaction.transaction_type == 'deposit' %}
                                            <span class="text-success">+{{ "{:,}".format(transaction.amount|int) }}</span>
                                        {% else %}
                                            <span class="text-error">-{{ "{:,}".format(transaction.amount|int) }}</span>
                                        {% endif %}
                                        <span class="text-xs opacity-60">ØªÙˆÙ…Ø§Ù†</span>
                                    </td>
                                    <td class="text-sm">
                                        {% if transaction.description %}
                                            {{ transaction.description[:30] }}{% if transaction.description|length > 30 %}...{% endif %}
                                        {% else %}
                                            <span class="opacity-50">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="font-mono">
                                        {% if running_balance >= 0 %}
                                            <span class="text-success">{{ "{:,}".format(running_balance|int) }}</span>
                                        {% else %}
                                            <span class="text-error">{{ "{:,}".format(running_balance|int) }}</span>
                                        {% endif %}
                                        <span class="text-xs opacity-60">ØªÙˆÙ…Ø§Ù†</span>
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            <a href="{{ url_for('partners.edit_transaction', partner_id=partner.id, transaction_id=transaction.id) }}"
                                               class="btn btn-xs btn-warning" title="ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´">
                                                âœï¸
                                            </a>
                                            <button onclick="deleteTransaction({{ transaction.id }})"
                                                    class="btn btn-xs btn-error" title="Ø­Ø°Ù ØªØ±Ø§Ú©Ù†Ø´">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="font-bold">
                                    <td colspan="2">Ø¬Ù…Ø¹ Ú©Ù„:</td>
                                    <td class="font-mono">
                                        {% if balance >= 0 %}
                                            <span class="text-success">{{ "{:,}".format(balance|int) }}</span>
                                        {% else %}
                                            <span class="text-error">{{ "{:,}".format(balance|int) }}</span>
                                        {% endif %}
                                        <span class="text-xs opacity-60">ØªÙˆÙ…Ø§Ù†</span>
                                    </td>
                                    <td colspan="3">Ù…Ø§Ù†Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-8 text-center text-base-content/50">
                        <div class="text-4xl mb-4">ğŸ’°</div>
                        <p class="mb-4">Ù‡Ù†ÙˆØ² ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <a href="{{ url_for('partners.add_transaction', id=partner.id) }}" class="btn btn-primary">
                            <span class="ml-2">â•</span>
                            Ø§ÙˆÙ„ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function deleteTransaction(transactionId) {
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ\n\nØ§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ø±ÛŒÚ© Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.')) {
        // Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª DELETE
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/partners/{{ partner.id }}/transactions/${transactionId}/delete`;

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† CSRF token
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = '{{ csrf_token() }}';
        form.appendChild(csrfToken);

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ù‡ ØµÙØ­Ù‡ Ùˆ Ø§Ø±Ø³Ø§Ù„
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
