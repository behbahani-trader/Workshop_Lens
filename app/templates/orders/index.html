{% extends "base.html" %}

{% block title %}Ø³ÙØ§Ø±Ø´Ø§Øª{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <span class="flex items-center gap-2 text-primary">
        <span>ğŸ“‹</span>
        <span>Ø³ÙØ§Ø±Ø´Ø§Øª</span>
    </span>
</li>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-4xl font-bold mb-2">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª</h1>
            <p class="text-base-content/70">Ù…Ø´Ø§Ù‡Ø¯Ù‡ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´Ø§Øª</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('orders.new') }}" class="btn btn-primary btn-lg">
                <span class="ml-2">â•</span>
                Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯
            </a>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-outline btn-lg">
                    <span class="ml-2">âš™ï¸</span>
                    Ø¹Ù…Ù„ÛŒØ§Øª
                </div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-100 rounded-box w-52">
                    <li><a href="#" class="flex items-center gap-3"><span>ğŸ“Š</span>Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
                    <li><a href="#" class="flex items-center gap-3"><span>ğŸ“¤</span>Ø®Ø±ÙˆØ¬ÛŒ Excel</a></li>
                    <li><a href="#" class="flex items-center gap-3"><span>ğŸ”„</span>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ù…Ù‡</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ Ùˆ Ø¬Ø³ØªØ¬Ùˆ - ÙØ´Ø±Ø¯Ù‡ -->
    <div class="collapse collapse-arrow bg-base-100 shadow-lg mb-6">
        <input type="checkbox" id="filters-toggle" />
        <div class="collapse-title min-h-0 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-lg font-medium">ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ùˆ ÙÛŒÙ„ØªØ±</span>
                    <div class="badge badge-neutral badge-sm" id="active-filters-count">0 ÙÛŒÙ„ØªØ± ÙØ¹Ø§Ù„</div>
                </div>
                <div class="flex gap-2">
                    <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹ -->
                    <div class="form-control">
                        <input type="text" id="quick-search" value="{{ search }}"
                               placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø³Ø±ÛŒØ¹..."
                               class="input input-bordered input-sm w-48"
                               onclick="event.stopPropagation()" />
                    </div>
                    <!-- ÙÛŒÙ„ØªØ± Ø³Ø±ÛŒØ¹ ÙˆØ¶Ø¹ÛŒØª -->
                    <select id="quick-status" class="select select-bordered select-sm" onclick="event.stopPropagation()">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="pending" {% if status == 'pending' %}selected{% endif %}>â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                        <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                        <option value="completed" {% if status == 'completed' %}selected{% endif %}>âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>âŒ Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="collapse-content">
            <div class="pt-4">
                <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ú©Ø§Ù…Ù„ -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
                    <div class="form-control">
                        <label class="label label-text-alt">
                            <span>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</span>
                        </label>
                        <input type="text" id="search" value="{{ search }}"
                               placeholder="Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ØŒ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ..."
                               class="input input-bordered input-sm" />
                    </div>

                    <!-- ÙÛŒÙ„ØªØ± ÙˆØ¶Ø¹ÛŒØª -->
                    <div class="form-control">
                        <label class="label label-text-alt">
                            <span>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª</span>
                        </label>
                        <select id="status" class="select select-bordered select-sm">
                            <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                            <option value="pending" {% if status == 'pending' %}selected{% endif %}>â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                            <option value="completed" {% if status == 'completed' %}selected{% endif %}>âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                            <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>âŒ Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>

                    <!-- ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ® -->
                    <div class="form-control">
                        <label class="label label-text-alt">
                            <span>ğŸ“… ØªØ§Ø±ÛŒØ®</span>
                        </label>
                        <select id="date_filter" class="select select-bordered select-sm">
                            <option value="">Ù‡Ù…Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§</option>
                            <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Ø§Ù…Ø±ÙˆØ²</option>
                            <option value="yesterday" {% if date_filter == 'yesterday' %}selected{% endif %}>Ø¯ÛŒØ±ÙˆØ²</option>
                            <option value="this_week" {% if date_filter == 'this_week' %}selected{% endif %}>Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ</option>
                            <option value="last_week" {% if date_filter == 'last_week' %}selected{% endif %}>Ù‡ÙØªÙ‡ Ú¯Ø°Ø´ØªÙ‡</option>
                            <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</option>
                            <option value="last_month" {% if date_filter == 'last_month' %}selected{% endif %}>Ù…Ø§Ù‡ Ú¯Ø°Ø´ØªÙ‡</option>
                        </select>
                    </div>

                    <!-- ÙÛŒÙ„ØªØ± Ù…Ø¨Ù„Øº -->
                    <div class="form-control">
                        <label class="label label-text-alt">
                            <span>ğŸ’° Ù…Ø¨Ù„Øº</span>
                        </label>
                        <select id="amount_filter" class="select select-bordered select-sm">
                            <option value="">Ù‡Ù…Ù‡ Ù…Ø¨Ø§Ù„Øº</option>
                            <option value="under_100k">Ø²ÛŒØ± 100 Ù‡Ø²Ø§Ø±</option>
                            <option value="100k_500k">100-500 Ù‡Ø²Ø§Ø±</option>
                            <option value="500k_1m">500 Ù‡Ø²Ø§Ø± - 1 Ù…ÛŒÙ„ÛŒÙˆÙ†</option>
                            <option value="over_1m">Ø¨Ø§Ù„Ø§ÛŒ 1 Ù…ÛŒÙ„ÛŒÙˆÙ†</option>
                        </select>
                    </div>
                </div>

                <!-- Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ… ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <!-- Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ -->
                    <div class="form-control">
                        <label class="label label-text-alt">
                            <span>ğŸ”„ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ</span>
                        </label>
                        <select id="sort_by" class="select select-bordered select-sm">
                            <option value="newest">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
                            <option value="oldest">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†</option>
                            <option value="amount_high">Ù…Ø¨Ù„Øº (Ø²ÛŒØ§Ø¯ Ø¨Ù‡ Ú©Ù…)</option>
                            <option value="amount_low">Ù…Ø¨Ù„Øº (Ú©Ù… Ø¨Ù‡ Ø²ÛŒØ§Ø¯)</option>
                            <option value="customer_name">Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</option>
                        </select>
                    </div>

                    <!-- ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´ -->
                    <div class="form-control">
                        <label class="label label-text-alt">
                            <span>ğŸ“„ ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´</span>
                        </label>
                        <select id="per_page" class="select select-bordered select-sm">
                            <option value="15">15 Ù…ÙˆØ±Ø¯</option>
                            <option value="25">25 Ù…ÙˆØ±Ø¯</option>
                            <option value="50">50 Ù…ÙˆØ±Ø¯</option>
                            <option value="100">100 Ù…ÙˆØ±Ø¯</option>
                        </select>
                    </div>

                    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª -->
                    <div class="form-control">
                        <label class="label label-text-alt">
                            <span>âš™ï¸ Ø¹Ù…Ù„ÛŒØ§Øª</span>
                        </label>
                        <div class="flex gap-2">
                            <button class="btn btn-outline btn-sm flex-1" onclick="clearFilters()">
                                <span>ğŸ—‘ï¸</span>Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                            </button>
                            <button class="btn btn-outline btn-sm flex-1" onclick="exportFiltered()">
                                <span>ğŸ“¤</span>Ø®Ø±ÙˆØ¬ÛŒ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ù†ØªØ§ÛŒØ¬ -->
                <div class="flex justify-between items-center pt-4 border-t border-base-300">
                    <div class="text-sm text-base-content/70">
                        <span id="results-info">
                            Ù†Ù…Ø§ÛŒØ´ {{ orders.items|length }} Ø§Ø² {{ orders.total }} Ø³ÙØ§Ø±Ø´
                        </span>
                    </div>
                    <div class="text-xs text-base-content/50">
                        Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹ Ø§Ø² ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stat bg-base-100 shadow-lg rounded-2xl">
            <div class="stat-figure text-primary">
                <span class="text-2xl">ğŸ“‹</span>
            </div>
            <div class="stat-title">Ú©Ù„ Ø³ÙØ§Ø±Ø´Ø§Øª</div>
            <div class="stat-value text-primary">{{ orders.total }}</div>
            <div class="stat-desc">Ø¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡: {{ orders.items|length }}</div>
        </div>

        <div class="stat bg-base-100 shadow-lg rounded-2xl">
            <div class="stat-figure text-warning">
                <span class="text-2xl">â³</span>
            </div>
            <div class="stat-title">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
            <div class="stat-value text-warning">{{ orders.items|selectattr('status', 'equalto', 'pending')|list|length }}</div>
            <div class="stat-desc">Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</div>
        </div>

        <div class="stat bg-base-100 shadow-lg rounded-2xl">
            <div class="stat-figure text-info">
                <span class="text-2xl">ğŸ”„</span>
            </div>
            <div class="stat-title">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</div>
            <div class="stat-value text-info">{{ orders.items|selectattr('status', 'equalto', 'in_progress')|list|length }}</div>
            <div class="stat-desc">Ø¯Ø± Ø¯Ø³Øª Ø§Ù‚Ø¯Ø§Ù…</div>
        </div>

        <div class="stat bg-base-100 shadow-lg rounded-2xl">
            <div class="stat-figure text-success">
                <span class="text-2xl">âœ…</span>
            </div>
            <div class="stat-title">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
            <div class="stat-value text-success">{{ orders.items|selectattr('status', 'equalto', 'completed')|list|length }}</div>
            <div class="stat-desc">Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„</div>
        </div>
    </div>

    <!-- Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">ğŸ“ Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª</h2>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline" onclick="selectAll()">
                        <span class="ml-1">â˜‘ï¸</span>Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="exportSelected()">
                        <span class="ml-1">ğŸ“¤</span>Ø®Ø±ÙˆØ¬ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" class="checkbox" id="selectAllCheckbox" onchange="toggleAll(this)">
                            </th>
                            <th>Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´</th>
                            <th>Ù…Ø´ØªØ±ÛŒ</th>
                            <th>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ù…Ø¨Ù„Øº Ú©Ù„</th>
                            <th>ØªØ³ÙˆÛŒÙ‡</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders.items %}
                        <tr class="hover">
                            <td>
                                <input type="checkbox" class="checkbox order-checkbox" value="{{ order.id }}">
                            </td>
                            <td>
                                <div class="font-mono font-bold text-primary">{{ order.order_number }}</div>
                            </td>
                            <td>
                                <div class="font-bold">{{ order.customer.full_name }}</div>
                            </td>
                            <td>
                                <span class="font-medium">{{ order.created_at.strftime('%Y/%m/%d') if order.created_at else '' }}</span>
                            </td>
                            <td>
                                <div class="dropdown dropdown-end">
                                    {% if order.status == 'pending' %}
                                        <div tabindex="0" role="button" class="badge badge-warning gap-2 cursor-pointer">
                                            <span>â³</span>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
                                        </div>
                                    {% elif order.status == 'in_progress' %}
                                        <div tabindex="0" role="button" class="badge badge-info gap-2 cursor-pointer">
                                            <span>ğŸ”„</span>Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…
                                        </div>
                                    {% elif order.status == 'completed' %}
                                        <div tabindex="0" role="button" class="badge badge-success gap-2 cursor-pointer">
                                            <span>âœ…</span>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡
                                        </div>
                                    {% elif order.status == 'cancelled' %}
                                        <div tabindex="0" role="button" class="badge badge-error gap-2 cursor-pointer">
                                            <span>âŒ</span>Ù„ØºÙˆ Ø´Ø¯Ù‡
                                        </div>
                                    {% endif %}

                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-100 rounded-box w-52">
                                        <li class="menu-title">ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</li>
                                        {% if order.status != 'pending' %}
                                        <li>
                                            <button onclick="updateOrderStatus({{ order.id }}, 'pending', this)" class="flex items-center gap-3 w-full">
                                                <span>â³</span>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
                                            </button>
                                        </li>
                                        {% endif %}
                                        {% if order.status != 'in_progress' %}
                                        <li>
                                            <button onclick="updateOrderStatus({{ order.id }}, 'in_progress', this)" class="flex items-center gap-3 w-full">
                                                <span>ğŸ”„</span>Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…
                                            </button>
                                        </li>
                                        {% endif %}
                                        {% if order.status != 'completed' %}
                                        <li>
                                            <button onclick="updateOrderStatus({{ order.id }}, 'completed', this)" class="flex items-center gap-3 w-full">
                                                <span>âœ…</span>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡
                                            </button>
                                        </li>
                                        {% endif %}
                                        {% if order.status != 'cancelled' %}
                                        <li>
                                            <button onclick="updateOrderStatus({{ order.id }}, 'cancelled', this)" class="flex items-center gap-3 w-full">
                                                <span>âŒ</span>Ù„ØºÙˆ Ø´Ø¯Ù‡
                                            </button>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="badge badge-neutral">
                                        {{ order.lenses|map(attribute='quantity')|sum if order.lenses else 0 }}
                                    </div>
                                    <span class="text-xs opacity-50">Ø¹Ø¯Ø¯</span>
                                </div>
                            </td>
                            <td>
                                <div class="flex flex-col">
                                    <span class="font-bold text-lg">{{ "{:,}".format(order.total_amount|int) }}</span>
                                    <span class="text-xs opacity-50">ØªÙˆÙ…Ø§Ù†</span>
                                </div>
                            </td>
                            <td>
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span class="badge badge-{{ order.settlement_status_color }} badge-sm">
                                            {{ order.settlement_status_display }}
                                        </span>
                                        <button class="btn btn-xs btn-primary" onclick="openSettlementModal({{ order.id }})">
                                            ğŸ’° ØªØ³ÙˆÛŒÙ‡
                                        </button>
                                    </div>
                                    {% if order.total_paid_amount > 0 %}
                                    <div class="text-xs opacity-70">
                                        {% if order.payment > 0 %}
                                        Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª: {{ "{:,}".format(order.payment|int) }}
                                        {% endif %}
                                        {% if order.paid_amount > 0 %}
                                        {% if order.payment > 0 %} | {% endif %}ØªØ³ÙˆÛŒÙ‡: {{ "{:,}".format(order.paid_amount|int) }}
                                        {% endif %}
                                        {% if order.remaining_amount > 0 %}
                                        | Ù…Ø§Ù†Ø¯Ù‡: {{ "{:,}".format(order.remaining_amount|int) }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="dropdown dropdown-end">
                                    <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                                        <span>âš™ï¸</span>
                                    </div>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-100 rounded-box w-52">
                                        <li>
                                            <a href="{{ url_for('orders.show', id=order.id) }}" class="flex items-center gap-3">
                                                <span>ğŸ‘ï¸</span>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                                            </a>
                                        </li>
                                        <li>
                                            <a href="{{ url_for('orders.edit', id=order.id) }}" class="flex items-center gap-3">
                                                <span>âœï¸</span>ÙˆÛŒØ±Ø§ÛŒØ´
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#" class="flex items-center gap-3">
                                                <span>ğŸ–¨ï¸</span>Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#" class="flex items-center gap-3">
                                                <span>ğŸ“‹</span>Ú©Ù¾ÛŒ Ø´Ù…Ø§Ø±Ù‡
                                            </a>
                                        </li>
                                        <li><hr class="my-1"></li>
                                        <li>
                                            <form method="POST" action="{{ url_for('orders.delete', id=order.id) }}" class="w-full" onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ');">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="flex items-center gap-3 w-full text-error">
                                                    <span>ğŸ—‘ï¸</span>Ø­Ø°Ù Ø³ÙØ§Ø±Ø´
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
            {% if orders.pages > 1 %}
            <div class="flex justify-center mt-4">
                <div class="btn-group">
                    {% if orders.has_prev %}
                    <a href="{{ url_for('orders.index', page=orders.prev_num, search=search, status=status) }}" class="btn btn-sm">Ù‚Ø¨Ù„ÛŒ</a>
                    {% endif %}
                    
                    {% for page_num in orders.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                        {% if page_num %}
                            {% if page_num == orders.page %}
                            <button class="btn btn-sm btn-active">{{ page_num }}</button>
                            {% else %}
                            <a href="{{ url_for('orders.index', page=page_num, search=search, status=status) }}" class="btn btn-sm">{{ page_num }}</a>
                            {% endif %}
                        {% else %}
                            <button class="btn btn-sm btn-disabled">...</button>
                        {% endif %}
                    {% endfor %}
                    
                    {% if orders.has_next %}
                    <a href="{{ url_for('orders.index', page=orders.next_num, search=search, status=status) }}" class="btn btn-sm">Ø¨Ø¹Ø¯ÛŒ</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal ØªØ³ÙˆÛŒÙ‡ -->
<dialog id="settlementModal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
        </form>
        <h3 class="font-bold text-lg mb-4">ğŸ’° ØªØ³ÙˆÛŒÙ‡ Ø³ÙØ§Ø±Ø´</h3>

        <div id="settlementContent">
            <!-- Ù…Ø­ØªÙˆØ§ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
        </div>

        <form id="settlementForm" class="space-y-4">
            <input type="hidden" id="orderId" name="order_id">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ (ØªÙˆÙ…Ø§Ù†)</span>
                    <span class="label-text-alt text-error">*</span>
                </label>
                <input type="number" id="paidAmount" name="paid_amount"
                       placeholder="Ù…Ø¨Ù„ØºÛŒ Ú©Ù‡ Ù…Ø´ØªØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù‡..."
                       class="input input-bordered" required min="1">
                <div class="label">
                    <span class="label-text-alt" id="remainingInfo"></span>
                </div>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ØªØ³ÙˆÛŒÙ‡</span>
                </label>
                <textarea id="settlementNotes" name="settlement_notes"
                          placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª..."
                          class="textarea textarea-bordered h-20"></textarea>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-outline" onclick="closeSettlementModal()">Ø§Ù†ØµØ±Ø§Ù</button>
                <button type="submit" class="btn btn-success">
                    <span class="ml-2">âœ…</span>
                    Ø«Ø¨Øª ØªØ³ÙˆÛŒÙ‡
                </button>
            </div>
        </form>
    </div>
</dialog>

{% block scripts %}
<script>
// ÙÛŒÙ„ØªØ± Ø®ÙˆØ¯Ú©Ø§Ø±
let searchTimeout;

// ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø³Ø±ÛŒØ¹
document.getElementById('quick-search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('search').value = this.value;
        updateFilters();
    }, 500);
});

document.getElementById('quick-status').addEventListener('change', function() {
    document.getElementById('status').value = this.value;
    updateFilters();
});

// ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ú©Ø§Ù…Ù„
document.getElementById('search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('quick-search').value = this.value;
        updateFilters();
    }, 500);
});

document.getElementById('status').addEventListener('change', function() {
    document.getElementById('quick-status').value = this.value;
    updateFilters();
});

document.getElementById('date_filter').addEventListener('change', updateFilters);
document.getElementById('amount_filter').addEventListener('change', updateFilters);
document.getElementById('sort_by').addEventListener('change', updateFilters);
document.getElementById('per_page').addEventListener('change', updateFilters);

function updateFilters() {
    const search = document.getElementById('search').value;
    const status = document.getElementById('status').value;
    const dateFilter = document.getElementById('date_filter').value;
    const amountFilter = document.getElementById('amount_filter').value;
    const sortBy = document.getElementById('sort_by').value;
    const perPage = document.getElementById('per_page').value;

    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (status) params.append('status', status);
    if (dateFilter) params.append('date_filter', dateFilter);
    if (amountFilter) params.append('amount_filter', amountFilter);
    if (sortBy && sortBy !== 'newest') params.append('sort_by', sortBy);
    if (perPage && perPage !== '15') params.append('per_page', perPage);

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„
    updateActiveFiltersCount();

    window.location.href = `{{ url_for('orders.index') }}?${params.toString()}`;
}

function clearFilters() {
    document.getElementById('quick-search').value = '';
    document.getElementById('quick-status').value = '';
    document.getElementById('search').value = '';
    document.getElementById('status').value = '';
    document.getElementById('date_filter').value = '';
    document.getElementById('amount_filter').value = '';
    document.getElementById('sort_by').value = 'newest';
    document.getElementById('per_page').value = '15';

    updateActiveFiltersCount();
    window.location.href = '{{ url_for("orders.index") }}';
}

// ØªØ§Ø¨Ø¹ Ø´Ù…Ø§Ø±Ø´ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„
function updateActiveFiltersCount() {
    const search = document.getElementById('search').value;
    const status = document.getElementById('status').value;
    const dateFilter = document.getElementById('date_filter').value;
    const amountFilter = document.getElementById('amount_filter').value;
    const sortBy = document.getElementById('sort_by').value;
    const perPage = document.getElementById('per_page').value;

    let count = 0;
    if (search) count++;
    if (status) count++;
    if (dateFilter) count++;
    if (amountFilter) count++;
    if (sortBy && sortBy !== 'newest') count++;
    if (perPage && perPage !== '15') count++;

    const badge = document.getElementById('active-filters-count');
    if (count > 0) {
        badge.textContent = `${count} ÙÛŒÙ„ØªØ± ÙØ¹Ø§Ù„`;
        badge.className = 'badge badge-primary badge-sm';
    } else {
        badge.textContent = '0 ÙÛŒÙ„ØªØ± ÙØ¹Ø§Ù„';
        badge.className = 'badge badge-neutral badge-sm';
    }
}
function updateActiveFiltersCount() {
    const search = document.getElementById('search').value;
    const status = document.getElementById('status').value;
    const dateFilter = document.getElementById('date_filter').value;
    const amountFilter = document.getElementById('amount_filter').value;
    const sortBy = document.getElementById('sort_by').value;
    const perPage = document.getElementById('per_page').value;

    let count = 0;
    if (search) count++;
    if (status) count++;
    if (dateFilter) count++;
    if (amountFilter) count++;
    if (sortBy && sortBy !== 'newest') count++;
    if (perPage && perPage !== '15') count++;

    const badge = document.getElementById('active-filters-count');
    if (count > 0) {
        badge.textContent = `${count} ÙÛŒÙ„ØªØ± ÙØ¹Ø§Ù„`;
        badge.className = 'badge badge-primary badge-sm';
    } else {
        badge.textContent = '0 ÙÛŒÙ„ØªØ± ÙØ¹Ø§Ù„';
        badge.className = 'badge badge-neutral badge-sm';
    }
}

function exportFiltered() {
    const activeFilters = [];
    const search = document.getElementById('search').value;
    const status = document.getElementById('status').value;
    const dateFilter = document.getElementById('date_filter').value;

    if (search) activeFilters.push(`Ø¬Ø³ØªØ¬Ùˆ: ${search}`);
    if (status) activeFilters.push(`ÙˆØ¶Ø¹ÛŒØª: ${document.getElementById('status').selectedOptions[0].text}`);
    if (dateFilter) activeFilters.push(`ØªØ§Ø±ÛŒØ®: ${document.getElementById('date_filter').selectedOptions[0].text}`);

    if (activeFilters.length === 0) {
        alert('Ù‡ÛŒÚ† ÙÛŒÙ„ØªØ±ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª. Ù‡Ù…Ù‡ Ø³ÙØ§Ø±Ø´Ø§Øª Ø®Ø±ÙˆØ¬ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
    } else {
        alert(`Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø²ÛŒØ±:\n${activeFilters.join('\n')}\n\nÙ‚Ø§Ø¨Ù„ÛŒØª Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`);
    }
}

function saveFilter() {
    const filterName = prompt('Ù†Ø§Ù… ÙÛŒÙ„ØªØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
    if (filterName) {
        // TODO: Ø°Ø®ÛŒØ±Ù‡ ÙÛŒÙ„ØªØ± Ø¯Ø± localStorage ÛŒØ§ Ø³Ø±ÙˆØ±
        alert(`ÙÛŒÙ„ØªØ± "${filterName}" Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.\n\nÙ‚Ø§Ø¨Ù„ÛŒØª Ø°Ø®ÛŒØ±Ù‡ ÙÛŒÙ„ØªØ± Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ú©Ø§Ù…Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`);
    }
}

// Ù…Ø¯ÛŒØ±ÛŒØª checkbox Ù‡Ø§
function toggleAll(source) {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = source.checked;
    });
    updateSelectedCount();
}

function selectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = true;
    toggleAll(selectAllCheckbox);
}

function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const count = selectedCheckboxes.length;

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ØªÙ† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    const selectAllBtn = document.querySelector('button[onclick="selectAll()"]');
    const exportBtn = document.querySelector('button[onclick="exportSelected()"]');

    if (count > 0) {
        selectAllBtn.innerHTML = `<span class="ml-1">â˜‘ï¸</span>Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡: ${count}`;
        exportBtn.innerHTML = `<span class="ml-1">ğŸ“¤</span>Ø®Ø±ÙˆØ¬ÛŒ ${count} Ù…ÙˆØ±Ø¯`;
        exportBtn.disabled = false;
    } else {
        selectAllBtn.innerHTML = `<span class="ml-1">â˜‘ï¸</span>Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡`;
        exportBtn.innerHTML = `<span class="ml-1">ğŸ“¤</span>Ø®Ø±ÙˆØ¬ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`;
        exportBtn.disabled = true;
    }
}

function exportSelected() {
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (selectedIds.length === 0) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø³ÙØ§Ø±Ø´ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
    }

    // ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
    alert(`${selectedIds.length} Ø³ÙØ§Ø±Ø´ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:\n${selectedIds.join(', ')}\n\nÙ‚Ø§Ø¨Ù„ÛŒØª Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`);

    // TODO: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Excel
    // const form = document.createElement('form');
    // form.method = 'POST';
    // form.action = '/orders/export';
    // ... rest of implementation
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ù‡ checkbox Ù‡Ø§
document.addEventListener('DOMContentLoaded', function() {
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    orderCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    updateSelectedCount();
    updateActiveFiltersCount();
});

// ØªØ§Ø¨Ø¹ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ AJAX
async function updateOrderStatus(orderId, newStatus, buttonElement) {
    const statusNames = {
        'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
        'in_progress': 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…',
        'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
        'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
    };

    const statusIcons = {
        'pending': 'â³',
        'in_progress': 'ğŸ”„',
        'completed': 'âœ…',
        'cancelled': 'âŒ'
    };

    const statusColors = {
        'pending': 'badge-warning',
        'in_progress': 'badge-info',
        'completed': 'badge-success',
        'cancelled': 'badge-error'
    };

    // Ø°Ø®ÛŒØ±Ù‡ Ù…ØªÙ† Ø§ØµÙ„ÛŒ
    const originalText = buttonElement.innerHTML;

    try {
        // Ù†Ù…Ø§ÛŒØ´ loading
        buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Ø¯Ø± Ø­Ø§Ù„ ØªØºÛŒÛŒØ±...';
        buttonElement.disabled = true;

        // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª AJAX
        const response = await fetch(`/orders/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `csrf_token={{ csrf_token() }}&status=${newStatus}`
        });

        if (response.ok) {
            const result = await response.json();

            if (result.success) {
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† badge ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ø¬Ø¯ÙˆÙ„
                const row = buttonElement.closest('tr');
                const statusBadge = row.querySelector('.badge');

                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ badge
                statusBadge.className = `badge ${statusColors[newStatus]} gap-2`;
                statusBadge.innerHTML = `<span>${statusIcons[newStatus]}</span>${statusNames[newStatus]}`;

                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
                updateStatsAfterStatusChange();

                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                showToast(`ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ "${statusNames[newStatus]}" ØªØºÛŒÛŒØ± ÛŒØ§ÙØª`, 'success');

                // Ø¨Ø³ØªÙ† dropdown
                const dropdown = buttonElement.closest('.dropdown');
                if (dropdown) {
                    dropdown.removeAttribute('open');
                    dropdown.blur();
                    // Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬ Ø§Ø² dropdown Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ†
                    document.body.click();
                }

                // refresh ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² 1 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ù…Ù„
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } else {
                throw new Error(result.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª');
            }
        } else {
            throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        }

    } catch (error) {
        console.error('Error updating status:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´', 'error');

    } finally {
        // Ù‡Ù…ÛŒØ´Ù‡ Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù† Ùˆ Ø¯Ú©Ù…Ù‡ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
        buttonElement.innerHTML = originalText;
        buttonElement.disabled = false;
    }
}

// ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ toast notification
function showToast(message, type = 'info') {
    // Ø­Ø°Ù toast Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    const existingToasts = document.querySelectorAll('.toast-notification');
    existingToasts.forEach(toast => toast.remove());

    // Ø§ÛŒØ¬Ø§Ø¯ toast Ø¬Ø¯ÛŒØ¯
    const toast = document.createElement('div');
    toast.className = `toast-notification alert alert-${type} fixed top-4 right-4 z-50 w-auto max-w-sm shadow-lg`;
    toast.innerHTML = `
        <div class="flex items-center gap-2">
            <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(toast);

    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±ÙˆØ¯
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
    }, 10);

    // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
function updateStatsAfterStatusChange() {
    // TODO: Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø±ÛŒ Ø¨Ø¯ÙˆÙ† refresh
    // Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø§ AJAX Ø¢Ù…Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯
}

// ØªØ³ÙˆÛŒÙ‡ Ø³ÙØ§Ø±Ø´
function openSettlementModal(orderId) {
    document.getElementById('orderId').value = orderId;

    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´
    fetch(`/orders/${orderId}/settlement-history`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('settlementContent').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-base-200 rounded-lg">
                    <div>
                        <div class="text-sm opacity-70">Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´</div>
                        <div class="font-bold">${data.order_number}</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-70">Ù…Ø´ØªØ±ÛŒ</div>
                        <div class="font-bold">${data.customer_name}</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-70">Ù…Ø¨Ù„Øº Ú©Ù„</div>
                        <div class="font-bold text-lg">${data.total_amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-70">Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</div>
                        <div class="font-bold text-info">${data.prepayment.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-70">ØªØ³ÙˆÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ</div>
                        <div class="font-bold text-warning">${data.paid_amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-70">Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</div>
                        <div class="font-bold text-success">${data.total_paid_amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="text-sm opacity-70">Ù…Ø§Ù†Ø¯Ù‡</div>
                        <div class="font-bold text-lg ${data.remaining_amount > 0 ? 'text-error' : 'text-success'}">
                            ${data.remaining_amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†
                        </div>
                    </div>
                </div>
            `;

            // ØªÙ†Ø¸ÛŒÙ… Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª
            document.getElementById('paidAmount').max = data.remaining_amount;
            document.getElementById('remainingInfo').textContent =
                `Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: ${data.remaining_amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;

            // Ù†Ù…Ø§ÛŒØ´ modal
            document.getElementById('settlementModal').showModal();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´');
        });
}

function closeSettlementModal() {
    document.getElementById('settlementModal').close();
    document.getElementById('settlementForm').reset();
}

// Ø«Ø¨Øª ØªØ³ÙˆÛŒÙ‡
document.getElementById('settlementForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const orderId = document.getElementById('orderId').value;
    const formData = new FormData(this);

    console.log('Submitting settlement for order:', orderId);
    console.log('Form data:', Object.fromEntries(formData));

    fetch(`/orders/${orderId}/settle`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            showToast(data.message, 'success');
            closeSettlementModal();
            setTimeout(() => location.reload(), 1000); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØµÙØ­Ù‡
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ³ÙˆÛŒÙ‡', 'error');
    });
});

// CSS Ø¨Ø±Ø§ÛŒ toast
const toastStyles = document.createElement('style');
toastStyles.textContent = `
    .toast-notification {
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
    }
`;
document.head.appendChild(toastStyles);
</script>
{% endblock %}
{% endblock %} 